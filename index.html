<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MermaidEase Pro - Enhanced Diagram Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --background-light: #f8f9fa;
            --text-dark: #2c3e50;
            --border-color: #e0e0e0;
            --node-color: #ecf0f1;
            --node-border: #2c3e50;
            --edge-color: #3498db;
            --header-bg: #f1f1f1;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: var(--background-light);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
        }

        /* Mobile-first responsive design */
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        @media (min-width: 768px) {
            .container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
                padding: 16px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                gap: 24px;
                padding: 24px;
            }
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: var(--header-bg);
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .editor-panel {
            flex: 1;
            min-height: 50vh;
        }

        .preview-panel {
            flex: 1;
            min-height: 50vh;
            position: relative;
        }

        @media (min-width: 768px) {
            .editor-panel, .preview-panel {
                min-height: calc(100vh - 32px);
            }
        }

        /* Code Editor */
        .editor-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        #code {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            resize: none;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            background: #fafafa;
            transition: border-color 0.3s ease;
            min-height: 200px;
        }

        #code:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* Controls */
        .controls-row {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--text-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn.secondary {
            background: var(--secondary-color);
        }

        .btn.success {
            background: var(--success-color);
        }

        .btn.small {
            padding: 6px 12px;
            font-size: 11px;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
            z-index: 1000;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 200px;
            box-shadow: var(--shadow-hover);
            z-index: 2000;
            border-radius: 8px;
            overflow: hidden;
            top: 100%;
            left: 0;
            border: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
        }

        /* Force dropdown to open upward when near bottom of viewport */
        .dropdown-content.dropdown-up {
            bottom: 100%;
            top: auto;
        }

        /* Ensure dropdown is fully visible */
        .dropdown-content.dropdown-right {
            left: auto;
            right: 0;
        }

        .dropdown-content.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        /* Preview Panel */
        .preview-content {
            flex: 1;
            overflow: auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            min-height: 400px;
        }

        .preview-controls {
            position: absolute;
            top: 80px;
            right: 16px;
            z-index: 100;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .control-btn {
            background: rgba(44, 62, 80, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: var(--primary-color);
            transform: scale(1.05);
        }

        .control-btn.active {
            background: var(--warning-color);
        }

        /* Status indicators */
        .status-bar {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }

        .zoom-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Grid overlay */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0.1;
            background-image:
                linear-gradient(to right, #000 1px, transparent 1px),
                linear-gradient(to bottom, #000 1px, transparent 1px);
            background-size: 20px 20px;
            display: none;
        }

        .grid-overlay.active {
            display: block;
        }

        /* Mermaid styling */
        .mermaid {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: transform 0.2s ease;
            /* Ensure proper sizing and overflow handling */
            max-width: 100%;
            max-height: 100%;
            overflow: visible;
        }

        .mermaid svg {
            /* Fix SVG sizing issues */
            max-width: 100%;
            height: auto;
            /* Ensure SVG is not cut off */
            overflow: visible;
        }



        /* Active button state */
        .btn.active {
            background: #3498db;
            color: white;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }



        /* Settings panel */
        .settings-panel {
            position: absolute;
            top: 130px;
            right: 16px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-hover);
            z-index: 1500;
            width: 280px;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
            border: 1px solid var(--border-color);
        }

        .settings-panel.active {
            display: block;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h4 {
            margin: 0 0 12px 0;
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 600;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .setting-item label {
            flex: 1;
            font-size: 14px;
            margin-right: 8px;
        }

        .setting-item input,
        .setting-item select {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
        }

        /* Loading and error states */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 150;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffe3e6;
            color: #dc3545;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 14px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .success-message.show {
            transform: translateX(0);
        }

        /* Fullscreen mode */
        .preview-panel.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            background: white;
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .auto-save-indicator.saving {
            color: var(--warning-color);
        }

        .auto-save-indicator.saved {
            color: var(--success-color);
        }

        /* Keyboard shortcuts help */
        .shortcuts-help {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-hover);
            z-index: 2000;
            max-width: 400px;
            display: none;
        }

        .shortcuts-help.active {
            display: block;
        }

        /* Tutorial Modal */
        .tutorial-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .tutorial-modal.active {
            display: flex;
        }

        .tutorial-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            background: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .tutorial-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .tutorial-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tutorial-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tutorial-links {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
        }

        .tutorial-links h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .link-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .tutorial-link {
            display: block;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .tutorial-link:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tutorial-tabs {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: #e9ecef;
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: white;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .tab-panel {
            display: none;
            padding: 30px;
        }

        .tab-panel.active {
            display: block;
        }

        .tab-panel h3 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 20px;
        }

        .syntax-section {
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .syntax-section h4 {
            margin: 0;
            padding: 15px 20px;
            background: #f8f9fa;
            color: var(--primary-color);
            font-size: 16px;
            border-bottom: 1px solid #dee2e6;
        }

        .syntax-section pre {
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .syntax-section code {
            color: #333;
        }

        .copy-btn {
            margin: 15px 20px 20px;
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .shortcut-key {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        /* Mobile optimizations */
        @media (max-width: 767px) {
            .container {
                padding: 8px;
                gap: 8px;
            }

            .panel-header {
                padding: 12px;
            }

            .editor-content {
                padding: 12px;
            }

            .controls-row {
                gap: 6px;
                flex-wrap: wrap;
            }

            .btn {
                padding: 8px 12px;
                font-size: 11px;
                flex: 1;
                min-width: 80px;
            }

            .preview-controls {
                top: 8px;
                right: 8px;
                gap: 4px;
                flex-direction: column;
            }

            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .settings-panel {
                top: 50px;
                right: 8px;
                left: 8px;
                width: auto;
                max-height: 60vh;
            }

            .dropdown-content {
                min-width: 150px;
                max-width: 90vw;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-light: #1a1a1a;
                --text-dark: #e0e0e0;
                --header-bg: #2d2d2d;
                --border-color: #404040;
            }

            .panel {
                background: #2d2d2d;
            }

            #code {
                background: #1e1e1e;
                color: #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Editor Panel -->
        <div class="panel editor-panel">
            <div class="panel-header">
                <h2>🎨 MermaidEase Pro</h2>
                <div class="auto-save-indicator" id="autoSaveIndicator">
                    <span id="autoSaveText">Auto-save</span>
                </div>
            </div>
            <div class="editor-content">
                <textarea id="code" placeholder="Enter your Mermaid diagram code here...">graph TD
    A[🚀 Start] --> B{📋 Decision}
    B -->|✅ Yes| C[⚡ Action]
    B -->|❌ No| D[🏁 End]
    C --> D

    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#e8f5e8
    style D fill:#fce4ec</textarea>

                <div class="controls-row">
                    <button class="btn" onclick="renderDiagram()" title="Ctrl+Enter">
                        ⚡ Render
                    </button>

                    <div class="dropdown">
                        <button class="btn secondary" onclick="toggleDropdown('examples')">
                            📚 Examples
                        </button>
                        <div class="dropdown-content" id="examplesDropdown">
                            <div class="dropdown-item" onclick="loadExample('flowchart')">Flowchart</div>
                            <div class="dropdown-item" onclick="loadExample('sequence')">Sequence Diagram</div>
                            <div class="dropdown-item" onclick="loadExample('classDiagram')">Class Diagram</div>
                            <div class="dropdown-item" onclick="loadExample('gantt')">Gantt Chart</div>
                            <div class="dropdown-item" onclick="loadExample('stateDiagram')">State Diagram</div>
                            <div class="dropdown-item" onclick="loadExample('entityRelationship')">ER Diagram</div>
                        </div>
                    </div>

                    <button class="btn" onclick="showTutorial()" title="Mermaid Syntax Tutorial">
                        📖 Tutorial
                    </button>

                    <div class="dropdown">
                        <button class="btn success" onclick="toggleDropdown('export')">
                            💾 Export
                        </button>
                        <div class="dropdown-content" id="exportDropdown">
                            <div class="dropdown-item" onclick="exportDiagram('svg')">📄 SVG</div>
                            <div class="dropdown-item" onclick="exportDiagram('png')">🖼️ PNG</div>
                            <div class="dropdown-item" onclick="copyToClipboard('svg')">📋 Copy SVG</div>
                            <div class="dropdown-item" onclick="copyToClipboard('code')">📝 Copy Code</div>
                            <div class="dropdown-item" onclick="shareURL()">🔗 Share URL</div>
                        </div>
                    </div>
                </div>

                <div class="controls-row">
                    <button class="btn small" onclick="importFile()">📁 Import</button>
                    <button class="btn small secondary" onclick="saveFile()">💾 Save</button>
                    <button class="btn small" onclick="clearDiagram()">🗑️ Clear</button>
                    <button class="btn small" onclick="showShortcuts()">⌨️ Shortcuts</button>
                </div>

                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="panel preview-panel" id="previewPanel">
            <div class="panel-header">
                <h2>👁️ Live Preview</h2>
            </div>

            <div class="preview-content" id="previewContent">
                <div class="grid-overlay" id="gridOverlay"></div>

                <!-- Mermaid Diagram Container -->
                <div id="mermaidContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: auto; background: white; border-radius: 10px;">
                    <div class="mermaid" id="mermaidDiagram" style="max-width: 100%; max-height: 100%;"></div>
                </div>

                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    <span>Rendering diagram...</span>
                </div>
            </div>

            <div class="preview-controls">
                <button class="control-btn" onclick="toggleFullscreen()" title="Fullscreen (F11)">⛶</button>
                <button class="control-btn" onclick="zoomIn()" title="Zoom In (+)">+</button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out (-)">−</button>
                <button class="control-btn" onclick="resetZoom()" title="Reset Zoom (0)">↻</button>
                <button class="control-btn" onclick="toggleGrid()" title="Toggle Grid" id="gridBtn">⊞</button>
                <button class="control-btn" onclick="toggleSettings()" title="Settings">⚙️</button>
            </div>

            <div class="status-bar">
                <div class="zoom-info" id="zoomInfo">Zoom: 100%</div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel" id="settingsPanel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--primary-color);">⚙️ Settings</h3>
                    <button onclick="toggleSettings()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #666; padding: 4px;">✕</button>
                </div>
                <div class="settings-group">
                    <h4>🎨 Theme</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <div style="width: 24px; height: 24px; background: #2c3e50; border-radius: 50%; cursor: pointer; border: 2px solid transparent;" onclick="changeTheme('default')" class="theme-btn active" data-theme="default"></div>
                        <div style="width: 24px; height: 24px; background: #3498db; border-radius: 50%; cursor: pointer; border: 2px solid transparent;" onclick="changeTheme('blue')" class="theme-btn" data-theme="blue"></div>
                        <div style="width: 24px; height: 24px; background: #e74c3c; border-radius: 50%; cursor: pointer; border: 2px solid transparent;" onclick="changeTheme('red')" class="theme-btn" data-theme="red"></div>
                        <div style="width: 24px; height: 24px; background: #2ecc71; border-radius: 50%; cursor: pointer; border: 2px solid transparent;" onclick="changeTheme('green')" class="theme-btn" data-theme="green"></div>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>🔧 Diagram Settings</h4>
                    <div class="setting-item">
                        <label>Node Spacing:</label>
                        <input type="range" min="30" max="100" value="50" id="nodeSpacing" onchange="updateDiagramSettings()">
                    </div>
                    <div class="setting-item">
                        <label>Rank Spacing:</label>
                        <input type="range" min="50" max="150" value="100" id="rankSpacing" onchange="updateDiagramSettings()">
                    </div>
                    <div class="setting-item">
                        <label>Curve Style:</label>
                        <select id="curveStyle" onchange="updateDiagramSettings()">
                            <option value="basis">Curved</option>
                            <option value="linear">Straight</option>
                            <option value="step">Stepped</option>
                        </select>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>📤 Export Settings</h4>
                    <div class="setting-item">
                        <label>PNG Quality:</label>
                        <select id="pngQuality">
                            <option value="1">Standard (1x)</option>
                            <option value="2" selected>High (2x)</option>
                            <option value="3">Very High (3x)</option>
                            <option value="4">Ultra (4x)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Background:</label>
                        <select id="exportBackground">
                            <option value="white">White</option>
                            <option value="transparent">Transparent</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Format:</label>
                        <select id="exportFormat">
                            <option value="png">PNG Image</option>
                            <option value="svg">SVG Vector</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn small" onclick="quickExport()" style="flex: 1;">📤 Quick Export</button>
                    <button class="btn small secondary" onclick="resetSettings()">🔄 Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Message Toast -->
    <div class="success-message" id="successMessage"></div>

    <!-- Keyboard Shortcuts Help -->
    <div class="shortcuts-help" id="shortcutsHelp">
        <h3>⌨️ Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Render Diagram</span>
            <span class="shortcut-key">Ctrl + Enter</span>
        </div>
        <div class="shortcut-item">
            <span>Save Diagram</span>
            <span class="shortcut-key">Ctrl + S</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Fullscreen</span>
            <span class="shortcut-key">F11</span>
        </div>
        <div class="shortcut-item">
            <span>Zoom In</span>
            <span class="shortcut-key">Ctrl + Plus</span>
        </div>
        <div class="shortcut-item">
            <span>Zoom Out</span>
            <span class="shortcut-key">Ctrl + Minus</span>
        </div>
        <div class="shortcut-item">
            <span>Reset Zoom</span>
            <span class="shortcut-key">Ctrl + 0</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Grid</span>
            <span class="shortcut-key">Ctrl + G</span>
        </div>
        <button class="btn" onclick="hideShortcuts()" style="margin-top: 16px; width: 100%;">Close</button>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".mmd,.txt,.md" style="display: none;" onchange="handleFileImport(event)">

    <!-- Tutorial Modal -->
    <div class="tutorial-modal" id="tutorialModal">
        <div class="tutorial-content">
            <div class="tutorial-header">
                <h2>📖 Mermaid Syntax Tutorial</h2>
                <button onclick="hideTutorial()" class="tutorial-close">✕</button>
            </div>

            <div class="tutorial-links">
                <h3>📚 Official Resources</h3>
                <div class="link-grid">
                    <a href="https://mermaid.js.org/intro/syntax-reference.html" target="_blank" class="tutorial-link">
                        📋 Official Syntax Reference
                    </a>
                    <a href="https://mermaid.js.org/intro/" target="_blank" class="tutorial-link">
                        🚀 Getting Started Guide
                    </a>
                    <a href="https://mermaid.live/" target="_blank" class="tutorial-link">
                        🔧 Live Editor
                    </a>
                    <a href="https://github.com/mermaid-js/mermaid" target="_blank" class="tutorial-link">
                        💻 GitHub Repository
                    </a>
                </div>
            </div>

            <div class="tutorial-tabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('flowchart')">Flowchart</button>
                    <button class="tab-btn" onclick="showTab('sequence')">Sequence</button>
                    <button class="tab-btn" onclick="showTab('class')">Class</button>
                    <button class="tab-btn" onclick="showTab('er')">ER Diagram</button>
                    <button class="tab-btn" onclick="showTab('gantt')">Gantt</button>
                    <button class="tab-btn" onclick="showTab('state')">State</button>
                </div>

                <div class="tab-content">
                    <!-- Flowchart Tab -->
                    <div class="tab-panel active" id="flowchart-tab">
                        <h3>🔄 Flowchart Syntax</h3>
                        <div class="syntax-section">
                            <h4>Basic Structure:</h4>
                            <pre><code>graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action 1]
    B -->|No| D[Action 2]
    C --> E[End]
    D --> E</code></pre>
                            <button onclick="copyToEditor('flowchart-basic')" class="copy-btn">📋 Copy to Editor</button>
                        </div>

                        <div class="syntax-section">
                            <h4>Node Shapes:</h4>
                            <pre><code>graph LR
    A[Rectangle] --> B(Round edges)
    B --> C((Circle))
    C --> D{Diamond}
    D --> E>Flag]
    E --> F[/Parallelogram/]</code></pre>
                            <button onclick="copyToEditor('flowchart-shapes')" class="copy-btn">📋 Copy to Editor</button>
                        </div>

                        <div class="syntax-section">
                            <h4>Styling:</h4>
                            <pre><code>graph TD
    A[Start] --> B[Process]
    B --> C[End]

    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#e8f5e8</code></pre>
                            <button onclick="copyToEditor('flowchart-styling')" class="copy-btn">📋 Copy to Editor</button>
                        </div>
                    </div>

                    <!-- Sequence Tab -->
                    <div class="tab-panel" id="sequence-tab">
                        <h3>📞 Sequence Diagram Syntax</h3>
                        <div class="syntax-section">
                            <h4>Basic Structure:</h4>
                            <pre><code>sequenceDiagram
    participant A as Alice
    participant B as Bob
    A->>B: Hello Bob!
    B-->>A: Hello Alice!</code></pre>
                            <button onclick="copyToEditor('sequence-basic')" class="copy-btn">📋 Copy to Editor</button>
                        </div>

                        <div class="syntax-section">
                            <h4>Advanced Features:</h4>
                            <pre><code>sequenceDiagram
    participant U as User
    participant S as System
    participant D as Database

    U->>S: Login Request
    activate S
    S->>D: Validate User
    D-->>S: User Valid
    S-->>U: Login Success
    deactivate S

    Note over U,S: User is now logged in</code></pre>
                            <button onclick="copyToEditor('sequence-advanced')" class="copy-btn">📋 Copy to Editor</button>
                        </div>
                    </div>

                    <!-- Class Tab -->
                    <div class="tab-panel" id="class-tab">
                        <h3>🏗️ Class Diagram Syntax</h3>
                        <div class="syntax-section">
                            <h4>Basic Structure:</h4>
                            <pre><code>classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }

    class Dog {
        +String breed
        +bark()
    }

    Animal <|-- Dog</code></pre>
                            <button onclick="copyToEditor('class-basic')" class="copy-btn">📋 Copy to Editor</button>
                        </div>

                        <div class="syntax-section">
                            <h4>Visibility & Relationships:</h4>
                            <pre><code>classDiagram
    class BankAccount {
        +String owner
        +Decimal balance
        -String accountNumber
        #validateTransaction()
        +deposit(amount)
        +withdraw(amount)
    }

    class SavingsAccount {
        +Float interestRate
        +calculateInterest()
    }

    BankAccount <|-- SavingsAccount</code></pre>
                            <button onclick="copyToEditor('class-advanced')" class="copy-btn">📋 Copy to Editor</button>
                        </div>
                    </div>

                    <!-- ER Tab -->
                    <div class="tab-panel" id="er-tab">
                        <h3>🗄️ ER Diagram Syntax</h3>
                        <div class="syntax-section">
                            <h4>Basic Structure:</h4>
                            <pre><code>erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    PRODUCT ||--o{ LINE-ITEM : "ordered in"</code></pre>
                            <button onclick="copyToEditor('er-basic')" class="copy-btn">📋 Copy to Editor</button>
                        </div>

                        <div class="syntax-section">
                            <h4>With Attributes:</h4>
                            <pre><code>erDiagram
    CUSTOMER {
        int customer_id PK
        string first_name
        string last_name
        string email
    }

    ORDER {
        int order_id PK
        int customer_id FK
        date order_date
        decimal total_amount
    }

    CUSTOMER ||--o{ ORDER : places</code></pre>
                            <button onclick="copyToEditor('er-advanced')" class="copy-btn">📋 Copy to Editor</button>
                        </div>
                    </div>

                    <!-- Gantt Tab -->
                    <div class="tab-panel" id="gantt-tab">
                        <h3>📅 Gantt Chart Syntax</h3>
                        <div class="syntax-section">
                            <h4>Basic Structure:</h4>
                            <pre><code>gantt
    title Project Timeline
    dateFormat YYYY-MM-DD

    section Planning
    Requirements    :done, req, 2024-01-01, 2024-01-10
    Design         :active, design, 2024-01-08, 2024-01-20

    section Development
    Frontend       :frontend, 2024-01-15, 30d
    Backend        :backend, 2024-01-20, 25d</code></pre>
                            <button onclick="copyToEditor('gantt-basic')" class="copy-btn">📋 Copy to Editor</button>
                        </div>
                    </div>

                    <!-- State Tab -->
                    <div class="tab-panel" id="state-tab">
                        <h3>🔄 State Diagram Syntax</h3>
                        <div class="syntax-section">
                            <h4>Basic Structure:</h4>
                            <pre><code>stateDiagram-v2
    [*] --> Idle
    Idle --> Running : start
    Running --> Paused : pause
    Running --> Stopped : stop
    Paused --> Running : resume
    Paused --> Stopped : stop
    Stopped --> Idle : reset</code></pre>
                            <button onclick="copyToEditor('state-basic')" class="copy-btn">📋 Copy to Editor</button>
                        </div>

                        <div class="syntax-section">
                            <h4>Composite States:</h4>
                            <pre><code>stateDiagram-v2
    [*] --> Active

    state Active {
        [*] --> Processing
        Processing --> Validating
        Validating --> Processing
        Processing --> Complete
    }

    Active --> Inactive : timeout
    Inactive --> Active : restart</code></pre>
                            <button onclick="copyToEditor('state-advanced')" class="copy-btn">📋 Copy to Editor</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        let currentScale = 1;
        let panOffset = { x: 0, y: 0 };
        let isGridVisible = false;
        let isFullscreen = false;
        let autoSaveTimer = null;
        let currentDiagramHash = '';
        let mermaidInitialized = false;

























        // ===== INITIALIZATION =====
        window.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Initialize Mermaid
            initializeMermaid();

            // Load saved state
            loadFromStorage();

            // Setup event listeners
            setupEventListeners();

            // Auto-render initial diagram if there's content
            const code = document.getElementById('code').value.trim();
            if (code) {
                setTimeout(() => {
                    renderDiagram();
                }, 500);
            }

            // Show welcome message
            showSuccess('Welcome to MermaidEase Pro! 🎉✨');
        }

        function initializeMermaid() {
            if (mermaidInitialized) return;

            try {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose',
                    fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'basis'
                    },
                    sequence: {
                        useMaxWidth: true,
                        wrap: true
                    },
                    gantt: {
                        useMaxWidth: true
                    },
                    class: {
                        useMaxWidth: true
                    },
                    state: {
                        useMaxWidth: true
                    },
                    er: {
                        useMaxWidth: true
                    }
                });
                mermaidInitialized = true;
                console.log('Mermaid initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Mermaid:', error);
                showError('Failed to initialize Mermaid: ' + error.message);
            }
        }

        function setupEventListeners() {
            const codeEditor = document.getElementById('code');

            // Auto-save on code change
            codeEditor.addEventListener('input', debounce(autoSave, 2000));

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Close dropdowns when clicking outside
            document.addEventListener('click', closeDropdowns);

            // Tutorial modal event listeners
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideTutorial();
                }
            });

            // Close tutorial when clicking outside content
            const tutorialModal = document.getElementById('tutorialModal');
            if (tutorialModal) {
                tutorialModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideTutorial();
                    }
                });
            }
        }

        // ===== AUTO-SAVE & STORAGE =====
        function autoSave() {
            const code = document.getElementById('code').value;
            if (code.trim()) {
                localStorage.setItem('mermaid_code', code);
                updateAutoSaveIndicator('saved');
                setTimeout(() => updateAutoSaveIndicator(''), 2000);
            }
        }

        function updateAutoSaveIndicator(state) {
            const indicator = document.getElementById('autoSaveIndicator');
            const text = document.getElementById('autoSaveText');

            indicator.className = `auto-save-indicator ${state}`;

            switch (state) {
                case 'saving':
                    text.textContent = 'Saving...';
                    break;
                case 'saved':
                    text.textContent = 'Saved ✓';
                    break;
                default:
                    text.textContent = 'Auto-save';
            }
        }

        function loadFromStorage() {
            const savedCode = localStorage.getItem('mermaid_code');

            if (savedCode) {
                document.getElementById('code').value = savedCode;
            }
        }

        function saveToStorage() {
            const code = document.getElementById('code').value;
            localStorage.setItem('mermaid_code', code);
        }

        function renderDiagram() {
            const code = document.getElementById('code').value.trim();

            if (!code) {
                showError('Please enter some Mermaid code to render.');
                return;
            }

            // Show loading
            showLoading(true);
            clearError();

            try {
                // Initialize Mermaid if not already done
                if (!mermaidInitialized) {
                    initializeMermaid();
                }

                // Generate unique ID for this diagram
                const diagramId = 'mermaid-diagram-' + Date.now();

                // Clear previous diagram
                const mermaidContainer = document.getElementById('mermaidDiagram');
                mermaidContainer.innerHTML = '';
                mermaidContainer.removeAttribute('data-processed');

                // Render the diagram
                mermaid.render(diagramId, code).then(({ svg, bindFunctions }) => {
                    // Insert the SVG
                    mermaidContainer.innerHTML = svg;

                    // Bind any interactive functions
                    if (bindFunctions) {
                        bindFunctions(mermaidContainer);
                    }

                    // Apply current zoom and pan
                    applyTransform();

                    // Hide loading
                    showLoading(false);

                    // Update hash to track changes
                    currentDiagramHash = generateHash(code);

                    showSuccess('Diagram rendered successfully! 🎉');

                }).catch(error => {
                    console.error('Mermaid render error:', error);
                    showLoading(false);
                    showError('Failed to render diagram: ' + (error.message || 'Invalid syntax'));
                });

            } catch (error) {
                console.error('Mermaid error:', error);
                showLoading(false);
                showError('Failed to render diagram: ' + (error.message || 'Invalid syntax'));
            }
        }

        // ===== KEYBOARD SHORTCUTS =====
        function handleKeyboardShortcuts(e) {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    renderDiagram();
                }
                return;
            }

            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        renderDiagram();
                        break;
                    case 's':
                        e.preventDefault();
                        saveFile();
                        break;
                    case 'g':
                        e.preventDefault();
                        toggleGrid();
                        break;
                    case '=':
                    case '+':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        e.preventDefault();
                        resetZoom();
                        break;
                }
            } else {
                switch (e.key) {
                    case 'F11':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'Escape':
                        hideShortcuts();
                        closeDropdowns();
                        break;
                }
            }
        }

        // ===== ZOOM AND VIEW CONTROLS =====
        function zoomIn() {
            if (currentScale < 5) {
                currentScale *= 1.2;
                applyTransform();
            }
        }

        function zoomOut() {
            if (currentScale > 0.2) {
                currentScale /= 1.2;
                applyTransform();
            }
        }

        function resetZoom() {
            currentScale = 1;
            panOffset = { x: 0, y: 0 };
            applyTransform();
        }

        function updateZoomInfo() {
            const zoomInfo = document.getElementById('zoomInfo');
            if (zoomInfo) {
                zoomInfo.textContent = `Zoom: ${Math.round(currentScale * 100)}%`;
            }
        }

        function applyTransform() {
            const svg = document.querySelector('#mermaidContainer svg');
            if (svg) {
                svg.style.transform = `scale(${currentScale}) translate(${panOffset.x / currentScale}px, ${panOffset.y / currentScale}px)`;
                svg.style.transformOrigin = 'center center';
                updateZoomInfo();
            }
        }

        // ===== GRID AND FULLSCREEN =====
        function toggleGrid() {
            isGridVisible = !isGridVisible;
            const gridOverlay = document.getElementById('gridOverlay');
            const gridBtn = document.getElementById('gridBtn');

            if (isGridVisible) {
                gridOverlay.classList.add('active');
                gridBtn.classList.add('active');
                showSuccess('Grid enabled! 📐');
            } else {
                gridOverlay.classList.remove('active');
                gridBtn.classList.remove('active');
                showSuccess('Grid disabled! 📐');
            }
        }

        function toggleFullscreen() {
            const previewPanel = document.getElementById('previewPanel');
            isFullscreen = !isFullscreen;

            if (isFullscreen) {
                previewPanel.classList.add('fullscreen');
                showSuccess('Fullscreen mode enabled! Press F11 or Escape to exit.');
            } else {
                previewPanel.classList.remove('fullscreen');
                showSuccess('Fullscreen mode disabled!');
            }
        }

        // ===== SETTINGS AND UTILITIES =====
        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            settingsPanel.classList.toggle('active');
        }

        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (show) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        // ===== ERROR AND SUCCESS MESSAGES =====
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('active');
                setTimeout(() => {
                    errorElement.classList.remove('active');
                }, 5000);
            }
        }

        function clearError() {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.classList.remove('active');
            }
        }

        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            if (successElement) {
                successElement.textContent = message;
                successElement.classList.add('show');
                setTimeout(() => {
                    successElement.classList.remove('show');
                }, 3000);
            }
        }

        // ===== FILE OPERATIONS =====
        function saveFile() {
            const code = document.getElementById('code').value;
            const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
            saveAs(blob, 'diagram.mmd');
            showSuccess('File saved successfully! 💾');
        }

        function loadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.mmd,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('code').value = e.target.result;
                        renderDiagram();
                        showSuccess('File loaded successfully! 📂');
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // ===== UTILITY FUNCTIONS =====
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function generateHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash.toString();
        }

        function autoSave() {
            saveToStorage();
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                showSuccess('Auto-saved! 💾');
            }, 500);
        }

        function closeDropdowns() {
            // Close any open dropdowns
            document.querySelectorAll('.dropdown.active').forEach(dropdown => {
                dropdown.classList.remove('active');
            });
        }

        // ===== SHORTCUTS AND HELP =====
        function showShortcuts() {
            document.getElementById('shortcutsHelp').classList.add('active');
        }

        function hideShortcuts() {
            document.getElementById('shortcutsHelp').classList.remove('active');
        }

        // ===== TUTORIAL FUNCTIONS =====
        function showTutorial() {
            document.getElementById('tutorialModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideTutorial() {
            document.getElementById('tutorialModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function showTab(tabName) {
            // Remove active class from all tabs and panels
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

            // Add active class to selected tab and panel
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function copyToEditor(exampleType) {
            const examples = {
                'flowchart-basic': `graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action 1]
    B -->|No| D[Action 2]
    C --> E[End]
    D --> E`,

                'flowchart-shapes': `graph LR
    A[Rectangle] --> B(Round edges)
    B --> C((Circle))
    C --> D{Diamond}
    D --> E>Flag]
    E --> F[/Parallelogram/]`,

                'flowchart-styling': `graph TD
    A[Start] --> B[Process]
    B --> C[End]

    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#e8f5e8`,

                'sequence-basic': `sequenceDiagram
    participant A as Alice
    participant B as Bob
    A->>B: Hello Bob!
    B-->>A: Hello Alice!`,

                'sequence-advanced': `sequenceDiagram
    participant U as User
    participant S as System
    participant D as Database

    U->>S: Login Request
    activate S
    S->>D: Validate User
    D-->>S: User Valid
    S-->>U: Login Success
    deactivate S

    Note over U,S: User is now logged in`,

                'class-basic': `classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }

    class Dog {
        +String breed
        +bark()
    }

    Animal <|-- Dog`,

                'class-advanced': `classDiagram
    class BankAccount {
        +String owner
        +Decimal balance
        -String accountNumber
        #validateTransaction()
        +deposit(amount)
        +withdraw(amount)
    }

    class SavingsAccount {
        +Float interestRate
        +calculateInterest()
    }

    BankAccount <|-- SavingsAccount`,

                'er-basic': `erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    PRODUCT ||--o{ LINE-ITEM : "ordered in"`,

                'er-advanced': `erDiagram
    CUSTOMER {
        int customer_id PK
        string first_name
        string last_name
        string email
    }

    ORDER {
        int order_id PK
        int customer_id FK
        date order_date
        decimal total_amount
    }

    CUSTOMER ||--o{ ORDER : places`,

                'gantt-basic': `gantt
    title Project Timeline
    dateFormat YYYY-MM-DD

    section Planning
    Requirements    :done, req, 2024-01-01, 2024-01-10
    Design         :active, design, 2024-01-08, 2024-01-20

    section Development
    Frontend       :frontend, 2024-01-15, 30d
    Backend        :backend, 2024-01-20, 25d`,

                'state-basic': `stateDiagram-v2
    [*] --> Idle
    Idle --> Running : start
    Running --> Paused : pause
    Running --> Stopped : stop
    Paused --> Running : resume
    Paused --> Stopped : stop
    Stopped --> Idle : reset`,

                'state-advanced': `stateDiagram-v2
    [*] --> Active

    state Active {
        [*] --> Processing
        Processing --> Validating
        Validating --> Processing
        Processing --> Complete
    }

    Active --> Inactive : timeout
    Inactive --> Active : restart`
            };

            const code = examples[exampleType];
            if (code) {
                document.getElementById('code').value = code;
                hideTutorial();
                renderDiagram();
                showSuccess('Example copied to editor! 📋');
            }
        }

        function toggleDropdown(id) {
            // Prevent event bubbling
            event.stopPropagation();

            const dropdown = document.getElementById(id + 'Dropdown');

            if (!dropdown) {
                console.warn(`Dropdown with id "${id}Dropdown" not found`);
                return;
            }

            const isVisible = dropdown.classList.contains('show');

            // Close all dropdowns first
            closeDropdowns();

            // Toggle the requested dropdown
            if (!isVisible) {
                dropdown.classList.add('show');

                // Add click outside listener to close dropdown
                setTimeout(() => {
                    document.addEventListener('click', function closeOnClickOutside(e) {
                        if (!dropdown.contains(e.target) && !e.target.closest('.dropdown')) {
                            dropdown.classList.remove('show');
                            document.removeEventListener('click', closeOnClickOutside);
                        }
                    });
                }, 10);
            }
        }

        // ===== UI CONTROLS =====
        function toggleDropdown(id) {
            // Prevent event bubbling
            event.stopPropagation();

            const dropdown = document.getElementById(id + 'Dropdown');

            if (!dropdown) {
                console.warn(`Dropdown with id "${id}Dropdown" not found`);
                return;
            }

            const isVisible = dropdown.classList.contains('show');

            // Close all dropdowns first
            closeDropdowns();

            // Toggle the requested dropdown
            if (!isVisible) {
                // Calculate optimal position before showing
                positionDropdown(dropdown);

                dropdown.classList.add('show');

                // Add click outside listener to close dropdown
                setTimeout(() => {
                    document.addEventListener('click', function closeOnClickOutside(e) {
                        if (!dropdown.contains(e.target) && !e.target.closest('.dropdown')) {
                            dropdown.classList.remove('show');
                            document.removeEventListener('click', closeOnClickOutside);
                        }
                    });
                }, 10);
            }
        }

        function positionDropdown(dropdown) {
            // Reset positioning classes
            dropdown.classList.remove('dropdown-up', 'dropdown-right');

            // Get dropdown button and viewport dimensions
            const button = dropdown.parentElement.querySelector('button');
            const buttonRect = button.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;

            // Temporarily show dropdown to measure its dimensions
            dropdown.style.visibility = 'hidden';
            dropdown.style.display = 'block';
            const dropdownRect = dropdown.getBoundingClientRect();
            dropdown.style.display = '';
            dropdown.style.visibility = '';

            // Check if dropdown would be cut off at bottom
            const spaceBelow = viewportHeight - buttonRect.bottom;
            const spaceAbove = buttonRect.top;

            if (spaceBelow < dropdownRect.height && spaceAbove > dropdownRect.height) {
                dropdown.classList.add('dropdown-up');
            }

            // Check if dropdown would be cut off at right
            const spaceRight = viewportWidth - buttonRect.left;
            if (spaceRight < dropdownRect.width) {
                dropdown.classList.add('dropdown-right');
            }
        }

        function closeDropdowns() {
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        function toggleFullscreen() {
            const panel = document.getElementById('previewPanel');
            isFullscreen = !isFullscreen;

            if (isFullscreen) {
                panel.classList.add('fullscreen');
                document.body.style.overflow = 'hidden';
            } else {
                panel.classList.remove('fullscreen');
                document.body.style.overflow = '';
            }
        }

        function toggleGrid() {
            isGridVisible = !isGridVisible;
            const grid = document.getElementById('gridOverlay');
            const btn = document.getElementById('gridBtn');

            if (isGridVisible) {
                grid.classList.add('active');
                btn.classList.add('active');
            } else {
                grid.classList.remove('active');
                btn.classList.remove('active');
            }
        }

        function showShortcuts() {
            document.getElementById('shortcutsHelp').classList.add('active');
        }

        function hideShortcuts() {
            document.getElementById('shortcutsHelp').classList.remove('active');
        }



        // ===== EXAMPLES =====
        function loadExample(type) {
            const examples = {
                flowchart: `graph TD
    A[🚀 Start Project] --> B{📋 Requirements Clear?}
    B -->|✅ Yes| C[⚡ Begin Development]
    B -->|❌ No| D[📝 Gather Requirements]
    D --> B
    C --> E[🧪 Testing Phase]
    E --> F{🐛 Bugs Found?}
    F -->|✅ Yes| G[🔧 Fix Issues]
    F -->|❌ No| H[🚀 Deploy]
    G --> E
    H --> I[📊 Monitor & Maintain]`,

                sequence: `sequenceDiagram
    participant 👤 User as User
    participant 💻 App as Application
    participant 🗄️ DB as Database
    participant 📧 Email as Email Service

    👤 User->>💻 App: Submit Registration
    💻 App->>🗄️ DB: Check if user exists
    🗄️ DB-->>💻 App: User not found
    💻 App->>🗄️ DB: Create new user
    🗄️ DB-->>💻 App: User created
    💻 App->>📧 Email: Send welcome email
    📧 Email-->>💻 App: Email sent
    💻 App-->>👤 User: Registration successful`,

                classDiagram: `classDiagram
    class Animal {
        +String name
        +int age
        +String species
        +makeSound()
        +eat()
        +sleep()
    }

    class Dog {
        +String breed
        +boolean isGoodBoy
        +String favoritetoy
        +bark()
        +fetch()
        +wagTail()
    }

    class Cat {
        +String color
        +int livesRemaining
        +boolean isIndoor
        +meow()
        +scratch()
        +purr()
    }

    Animal <|-- Dog
    Animal <|-- Cat`,

                gantt: `gantt
    title 🚀 Project Development Timeline
    dateFormat YYYY-MM-DD
    section 📋 Planning
    Requirements Analysis    :done, req, 2024-01-01, 2024-01-10
    System Design          :done, design, 2024-01-08, 2024-01-20

    section 💻 Development
    Frontend Development    :active, frontend, 2024-01-15, 2024-02-28
    Backend Development     :backend, 2024-01-20, 2024-03-15
    Database Setup         :db, 2024-01-25, 2024-02-10

    section 🧪 Testing
    Unit Testing           :testing, after frontend, 10d
    Integration Testing    :integration, after backend, 15d
    User Acceptance Testing :uat, after integration, 10d

    section 🚀 Deployment
    Production Setup       :deploy, after uat, 5d
    Go Live               :milestone, golive, after deploy, 1d`,

                stateDiagram: `stateDiagram-v2
    [*] --> Idle
    Idle --> Running : start()
    Running --> Paused : pause()
    Running --> Stopped : stop()
    Paused --> Running : resume()
    Paused --> Stopped : stop()
    Stopped --> Idle : reset()
    Running --> Error : exception
    Error --> Idle : recover()

    state Running {
        [*] --> Processing
        Processing --> Validating
        Validating --> Processing
    }`,

                entityRelationship: `erDiagram
    CUSTOMER ||--o{ ORDER : "places"
    ORDER ||--|{ LINE-ITEM : "contains"
    CUSTOMER }|..|{ DELIVERY-ADDRESS : "uses"
    PRODUCT ||--o{ LINE-ITEM : "ordered in"
    ORDER }|--|| PAYMENT : "paid with"
    CUSTOMER }|--o{ PAYMENT : "makes"

    CUSTOMER {
        int customer_id PK
        string first_name
        string last_name
        string email
        string phone
    }

    ORDER {
        int order_id PK
        int customer_id FK
        date order_date
        decimal total_amount
        string status
    }

    PRODUCT {
        int product_id PK
        string name
        decimal price
        string category
        int stock_quantity
    }`
            };

            const code = examples[type];
            if (code) {
                document.getElementById('code').value = code;
                renderDiagram();
                closeDropdowns();
                showSuccess(`${type.charAt(0).toUpperCase() + type.slice(1)} example loaded! 📚`);
            }
        }

        // ===== EXPORT & SHARING =====
        function exportDiagram(format) {
            exportMermaidDiagram(format);
        }

        function quickExport() {
            const format = document.getElementById('exportFormat')?.value || 'png';
            exportMermaidDiagram(format);
        }

        function exportMermaidDiagram(format) {
            const svg = document.querySelector('#mermaidContainer svg');
            if (!svg) {
                showError('No diagram to export. Please render a diagram first.');
                return;
            }

            closeDropdowns();

            try {
                if (format === 'svg') {
                    exportMermaidSVG(svg);
                } else if (format === 'png') {
                    exportMermaidPNG(svg);
                } else {
                    showError('Unsupported export format: ' + format);
                }
            } catch (error) {
                showError('Export failed: ' + error.message);
                console.error('Export error:', error);
            }
        }

        function exportMermaidSVG(svg) {
            try {
                // Clone the SVG to avoid modifying the original
                const svgClone = svg.cloneNode(true);

                // Get the SVG content
                const svgData = new XMLSerializer().serializeToString(svgClone);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });

                // Create download link
                const link = document.createElement('a');
                link.download = 'mermaid-diagram.svg';
                link.href = URL.createObjectURL(blob);
                link.click();

                // Clean up
                URL.revokeObjectURL(link.href);
                showSuccess('Diagram exported as SVG! 📄');
            } catch (error) {
                showError('Failed to export SVG: ' + error.message);
                console.error('SVG export error:', error);
            }
        }

        function exportMermaidPNG(svg) {
            try {
                showLoading(true);

                // Get export settings
                const scaleFactor = parseInt(document.getElementById('pngQuality')?.value) || 2;
                const background = document.getElementById('exportBackground')?.value || 'white';

                // Get SVG dimensions - use actual SVG dimensions, not bounding rect
                const svgWidth = svg.viewBox?.baseVal?.width || svg.width?.baseVal?.value || svg.getBoundingClientRect().width;
                const svgHeight = svg.viewBox?.baseVal?.height || svg.height?.baseVal?.value || svg.getBoundingClientRect().height;

                // Ensure minimum dimensions for quality
                const baseWidth = Math.max(svgWidth, 800);
                const baseHeight = Math.max(svgHeight, 600);

                // Calculate high-resolution dimensions
                const finalWidth = baseWidth * scaleFactor;
                const finalHeight = baseHeight * scaleFactor;

                // Create high-DPI canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Set actual canvas size to high resolution
                canvas.width = finalWidth;
                canvas.height = finalHeight;

                // Set CSS size to maintain aspect ratio
                canvas.style.width = baseWidth + 'px';
                canvas.style.height = baseHeight + 'px';

                // Enable high-quality rendering
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.textRenderingOptimization = 'optimizeQuality';

                // Set background if specified
                if (background === 'white') {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, finalWidth, finalHeight);
                }

                // Clone and prepare SVG for high-resolution export
                const svgClone = svg.cloneNode(true);

                // Set explicit dimensions for crisp rendering
                svgClone.setAttribute('width', finalWidth);
                svgClone.setAttribute('height', finalHeight);
                svgClone.setAttribute('viewBox', `0 0 ${baseWidth} ${baseHeight}`);

                // Ensure proper XML namespaces
                if (!svgClone.getAttribute('xmlns')) {
                    svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                }
                if (!svgClone.getAttribute('xmlns:xlink')) {
                    svgClone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                }

                // Add styles for crisp rendering
                const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
                styleElement.textContent = `
                    * {
                        shape-rendering: geometricPrecision;
                        text-rendering: geometricPrecision;
                        image-rendering: optimizeQuality;
                    }
                `;
                svgClone.insertBefore(styleElement, svgClone.firstChild);

                // Serialize SVG with proper encoding
                const svgString = new XMLSerializer().serializeToString(svgClone);
                const encodedSvg = encodeURIComponent(svgString);
                const svgDataUrl = `data:image/svg+xml;charset=utf-8,${encodedSvg}`;

                const img = new Image();
                img.onload = function() {
                    try {
                        // Draw at full resolution for maximum quality
                        ctx.drawImage(img, 0, 0, finalWidth, finalHeight);

                        // Convert to PNG with maximum quality
                        canvas.toBlob(function(blob) {
                            showLoading(false);

                            if (blob) {
                                // Create download link
                                const link = document.createElement('a');
                                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                                const fileSize = (blob.size / (1024 * 1024)).toFixed(2);
                                link.download = `mermaid-diagram-${finalWidth}x${finalHeight}-${timestamp}.png`;
                                link.href = URL.createObjectURL(blob);

                                // Trigger download
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);

                                // Clean up
                                URL.revokeObjectURL(link.href);
                                showSuccess(`High-quality PNG exported! (${finalWidth}×${finalHeight}, ${fileSize}MB) 🖼️`);
                            } else {
                                showError('Failed to create PNG file');
                            }
                        }, 'image/png', 1.0); // Maximum quality

                    } catch (drawError) {
                        showLoading(false);
                        console.error('Canvas draw error:', drawError);
                        showError('Failed to draw diagram on canvas');
                    }
                };

                img.onerror = function(error) {
                    showLoading(false);
                    console.error('Image load error:', error);
                    showError('Failed to load SVG for PNG conversion. Try a simpler diagram or different export format.');
                };

                // Set image source to trigger loading
                img.src = svgDataUrl;

            } catch (error) {
                showLoading(false);
                showError('PNG export failed: ' + error.message);
                console.error('PNG export error:', error);
            }
        }

        function copyToClipboard(type) {
            closeDropdowns();

            if (type === 'code') {
                const code = document.getElementById('code').value;
                navigator.clipboard.writeText(code).then(() => {
                    showSuccess('Code copied to clipboard! 📝');
                }).catch(() => {
                    showError('Failed to copy to clipboard.');
                });
            }
        }

        function shareURL() {
            const code = document.getElementById('code').value;
            if (!code.trim()) {
                showError('No diagram to share.');
                return;
            }

            const encodedCode = btoa(unescape(encodeURIComponent(code)));
            const url = window.location.origin + window.location.pathname + '?code=' + encodedCode;

            navigator.clipboard.writeText(url).then(() => {
                showSuccess('Shareable URL copied to clipboard! 🔗');
            }).catch(() => {
                showError('Failed to copy URL to clipboard.');
            });

            closeDropdowns();
        }

        // ===== FILE OPERATIONS =====
        function importFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('code').value = e.target.result;
                renderDiagram();
                showSuccess(`File "${file.name}" imported successfully! 📁`);
            };
            reader.readAsText(file);
        }

        function clearDiagram() {
            if (confirm('Are you sure you want to clear the diagram?')) {
                document.getElementById('code').value = '';
                const mermaidContainer = document.getElementById('mermaidDiagram');
                mermaidContainer.innerHTML = '';
                saveToStorage();
                showSuccess('Diagram cleared! 🗑️');
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');

            setTimeout(() => {
                errorEl.classList.remove('active');
            }, 5000);
        }

        function clearError() {
            document.getElementById('errorMessage').classList.remove('active');
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.classList.add('show');

            setTimeout(() => {
                successEl.classList.remove('show');
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function generateHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // ===== SETTINGS FUNCTIONS =====
        function changeTheme(theme) {
            // Remove active class from all theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.border = '2px solid transparent';
            });

            // Add active class to selected theme button
            const selectedBtn = document.querySelector(`[data-theme="${theme}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.style.border = '2px solid #3498db';
            }

            // Apply theme to Mermaid
            let mermaidTheme = 'default';
            switch (theme) {
                case 'blue':
                    mermaidTheme = 'base';
                    break;
                case 'red':
                    mermaidTheme = 'dark';
                    break;
                case 'green':
                    mermaidTheme = 'forest';
                    break;
                default:
                    mermaidTheme = 'default';
            }

            // Reinitialize Mermaid with new theme
            mermaid.initialize({
                startOnLoad: false,
                theme: mermaidTheme,
                securityLevel: 'loose',
                fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis'
                }
            });

            // Re-render diagram with new theme
            renderDiagram();
            showSuccess(`Theme changed to ${theme}! 🎨`);
        }

        function updateDiagramSettings() {
            const nodeSpacing = document.getElementById('nodeSpacing').value;
            const rankSpacing = document.getElementById('rankSpacing').value;
            const curveStyle = document.getElementById('curveStyle').value;

            // Update Mermaid configuration
            mermaid.initialize({
                startOnLoad: false,
                theme: 'default',
                securityLevel: 'loose',
                fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: curveStyle,
                    nodeSpacing: parseInt(nodeSpacing),
                    rankSpacing: parseInt(rankSpacing)
                }
            });

            // Re-render diagram with new settings
            renderDiagram();
            showSuccess('Diagram settings updated! ⚙️');
        }

        function resetSettings() {
            // Reset theme
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.border = '2px solid transparent';
            });
            document.querySelector('[data-theme="default"]').classList.add('active');
            document.querySelector('[data-theme="default"]').style.border = '2px solid #3498db';

            // Reset diagram settings
            document.getElementById('nodeSpacing').value = 50;
            document.getElementById('rankSpacing').value = 100;
            document.getElementById('curveStyle').value = 'basis';

            // Reset export settings
            document.getElementById('pngQuality').value = 2;
            document.getElementById('exportBackground').value = 'white';
            document.getElementById('exportFormat').value = 'png';

            // Reinitialize Mermaid with default settings
            initializeMermaid();

            // Re-render diagram
            renderDiagram();
            showSuccess('Settings reset to defaults! 🔄');
        }

        // ===== URL PARAMETER HANDLING =====
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedCode = urlParams.get('code');

            if (encodedCode) {
                try {
                    const code = decodeURIComponent(escape(atob(encodedCode)));
                    document.getElementById('code').value = code;
                    renderDiagram();
                    showSuccess('Diagram loaded from URL! 🔗');
                } catch (e) {
                    showError('Invalid URL parameters.');
                }
            }
        }

        // Load from URL on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure other initialization is complete
            setTimeout(loadFromURL, 100);
        });

        // ===== DEFAULT CONTENT =====
        function setDefaultContent() {
            if (!document.getElementById('code').value.trim()) {
                document.getElementById('code').value = `Welcome to Interactive Canvas Editor!

🎯 Features:
- Drag boxes around the canvas
- Lines automatically follow connected boxes
- Smooth animations and interactions
- Export your diagrams as PNG

🚀 Getting Started:
1. Click "Add Box" to create new boxes
2. Drag boxes to move them around
3. Lines stay connected automatically
4. Use zoom controls for better view
5. Export when ready!

💡 Tips:
- Use Ctrl+N to add new boxes quickly
- Grid can be toggled for alignment
- All interactions are smooth and responsive`;
            }
        }

        // Set default content after a short delay to ensure DOM is ready
        setTimeout(() => {
            setDefaultContent();
        }, 200);
    </script>
</body>
</html>
